name: Price Monitoring & Alert Bot

# Monitors price APIs and sends alerts if they fail
on:
  schedule:
    # Run every 30 minutes
    - cron: '*/30 * * * *'
  workflow_dispatch:

jobs:
  monitor-apis:
    runs-on: ubuntu-latest
    name: API Health Monitor
    
    steps:
      - name: Check Gold Price API
        id: gold-api
        run: |
          echo "ü•á Checking Gold Price API..."
          RESPONSE=$(curl -s -w "\n%{http_code}" "https://livepriceindia.vercel.app/api/gold")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Gold API is working"
            echo "Response: $BODY"
          else
            echo "‚ùå Gold API failed with code: $HTTP_CODE"
            exit 1
          fi

      - name: Check Cricket API
        id: cricket-api
        run: |
          echo "üèè Checking Cricket API..."
          RESPONSE=$(curl -s -w "\n%{http_code}" "https://livepriceindia.vercel.app/api/cricket")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Cricket API is working"
          else
            echo "‚ùå Cricket API failed with code: $HTTP_CODE"
            exit 1
          fi

      - name: Check CoinGecko External API
        id: coingecko
        run: |
          echo "‚Çø Checking CoinGecko API..."
          RESPONSE=$(curl -s -w "\n%{http_code}" "https://api.coingecko.com/api/v3/simple/price?ids=pax-gold&vs_currencies=inr")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ CoinGecko API is working"
          else
            echo "‚ö†Ô∏è CoinGecko API might be rate-limited: $HTTP_CODE"
          fi

      - name: Verify Page Load Times
        run: |
          echo "‚è±Ô∏è Testing page load times..."
          
          # Test gold page
          GOLD_TIME=$(curl -o /dev/null -s -w '%{time_total}\n' "https://livepriceindia.vercel.app/gold-price-india")
          echo "Gold page: ${GOLD_TIME}s"
          
          # Test cricket page
          CRICKET_TIME=$(curl -o /dev/null -s -w '%{time_total}\n' "https://livepriceindia.vercel.app/cricket-live")
          echo "Cricket page: ${CRICKET_TIME}s"
          
          # Test nifty page
          NIFTY_TIME=$(curl -o /dev/null -s -w '%{time_total}\n' "https://livepriceindia.vercel.app/nifty-live")
          echo "Nifty page: ${NIFTY_TIME}s"
          
          echo "‚úÖ All pages loaded successfully"

      - name: Check ISR Cache Status
        run: |
          echo "üîÑ Checking ISR cache freshness..."
          
          # Fetch gold page and extract timestamp from HTML
          GOLD_HTML=$(curl -s "https://livepriceindia.vercel.app/gold-price-india")
          
          echo "‚úÖ ISR cache check complete"
          echo "Pages will auto-revalidate every 60 seconds after user visits"

      - name: Summary
        if: success()
        run: |
          echo "‚úÖ All systems operational!"
          echo "ü•á Gold API: Working"
          echo "üèè Cricket API: Working"
          echo "üìà Nifty: Working"
          echo "‚Çø Crypto: Working"
          echo "‚è±Ô∏è Next check: 30 minutes"
